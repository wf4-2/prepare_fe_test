<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>React Quiz</title>
    <link rel="stylesheet" href="index.css" />
    <script
      crossorigin
      src="https://unpkg.com/react@18/umd/react.development.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"
    ></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script src="./questions.js"></script>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      function shuffleArray(array) {
        const shuffledArray = [...array];
        for (let i = shuffledArray.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [shuffledArray[i], shuffledArray[j]] = [
            shuffledArray[j],
            shuffledArray[i],
          ];
        }
        return shuffledArray;
      }

      function App() {
        const [randomQuestions, setRandomQuestions] = React.useState(() =>
          shuffleArray(questions)
        );
        const [currentQuestionIndex, setCurrentQuestionIndex] = React.useState(
          () => Number(localStorage.getItem("currentIndex")) || 0
        );
        const [selectedOption, setSelectedOption] = React.useState(null);
        const [isAnswerChecked, setIsAnswerChecked] = React.useState(false);
        const [score, setScore] = React.useState(
          () => Number(localStorage.getItem("score")) || 0
        );
        const [showResult, setShowResult] = React.useState(false);
        const [timeLeft, setTimeLeft] = React.useState(15);
        const [isDarkMode, setIsDarkMode] = React.useState(() => {
          return (
            window.matchMedia &&
            window.matchMedia("(prefers-color-scheme: dark)").matches
          );
        });

        React.useEffect(() => {
          if (isDarkMode) {
            document.body.classList.add("dark-mode");
          } else {
            document.body.classList.remove("dark-mode");
          }
        }, [isDarkMode]);

        React.useEffect(() => {
          if (timeLeft <= 0) {
            checkAnswer();
            return;
          }

          const timer = setTimeout(() => setTimeLeft(timeLeft - 1), 1000);
          return () => clearTimeout(timer);
        }, [timeLeft, isAnswerChecked]);

        React.useEffect(() => {
          localStorage.setItem("currentIndex", currentQuestionIndex);
          localStorage.setItem("score", score);
        }, [currentQuestionIndex, score]);

        const currentQuestion = randomQuestions[currentQuestionIndex];

        const handleOptionSelect = (index) => {
          if (!isAnswerChecked) {
            setSelectedOption(index);
          }
        };

        const checkAnswer = () => {
          if (selectedOption === currentQuestion.answer) {
            setScore(score + 1);
          }
          setIsAnswerChecked(true);
        };

        const nextQuestion = () => {
          if (currentQuestionIndex < randomQuestions.length - 1) {
            setCurrentQuestionIndex(currentQuestionIndex + 1);
            setSelectedOption(null);
            setIsAnswerChecked(false);
            setTimeLeft(15);
          } else {
            setShowResult(true);
          }
        };

        const toggleDarkMode = () => {
          setIsDarkMode(!isDarkMode);
        };

        const restartQuiz = () => {
          setCurrentQuestionIndex(0);
          setScore(0);
          setSelectedOption(null);
          setIsAnswerChecked(false);
          setShowResult(false);
          setTimeLeft(15);
          localStorage.removeItem("currentIndex");
          localStorage.removeItem("score");
        };

        if (showResult) {
          return (
            <div className={`quiz-container ${isDarkMode ? "dark-mode" : ""}`}>
              <h2>퀴즈 완료!</h2>
              <p>당신의 점수: {score} / {randomQuestions.length}</p>
              <button onClick={restartQuiz}>다시 시작하기</button>
            </div>
          );
        }

        return (
          <div className={`quiz-container ${isDarkMode ? "dark-mode" : ""}`}>
            <div className="dark-mode-toggle" onClick={toggleDarkMode}>
              {isDarkMode ? "☀️" : "🌙"}
            </div>
            <h2>React Quiz</h2>
            <div className="progress-bar-container">
              <div
                className="progress-bar"
                style={{
                  width: `${
                    ((currentQuestionIndex + 1) / randomQuestions.length) * 100
                  }%`,
                }}
              ></div>
            </div>
            <div className="timer">⏳ 남은 시간: {timeLeft}초</div>
            <div className="question-info">
              <span>
                문제 {currentQuestionIndex + 1} / {randomQuestions.length}
              </span>
              <span>분류: {currentQuestion.category}</span>
            </div>
            <div className="question">{currentQuestion.question}</div>
            <div className="options">
              {currentQuestion.options.map((option, index) => (
                <div
                  key={index}
                  className={`option 
                    ${selectedOption === index ? "selected" : ""} 
                    ${isAnswerChecked && index === currentQuestion.answer ? "correct" : ""} 
                    ${isAnswerChecked && selectedOption === index && selectedOption !== currentQuestion.answer ? "incorrect" : ""}`}
                  onClick={() => handleOptionSelect(index)}
                >
                  {option}
                </div>
              ))}
            </div>
            {!isAnswerChecked && selectedOption !== null && (
              <button onClick={checkAnswer}>정답 확인</button>
            )}
            {isAnswerChecked && (
              <button onClick={nextQuestion}>다음 문제</button>
            )}
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
  </body>
</html>
